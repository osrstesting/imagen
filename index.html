<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor de Im√°genes Lote Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script> 
    <style>
        /* Estilos CSS */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #e9f5ff; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        h1 { color: #0056b3; font-size: 24px; margin-bottom: 5px;}
        h3 { color: #333; margin-top: 25px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        hr { border: 0; border-top: 1px solid #ccc; margin-bottom: 20px; }
        #drop-zone { 
            border: 3px dashed #007bff; padding: 50px 20px; text-align: center; margin-bottom: 20px; 
            cursor: pointer; background-color: #f8fbfc; border-radius: 8px; transition: background-color 0.2s, border-color 0.2s;
        }
        #drop-zone.hover { background-color: #cce0ff; border-color: #0056b3; }
        /* Carga por URL */
        #url-input-container {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        #url-input-container input {
            flex-grow: 1; padding: 10px; border-radius: 4px; border: 1px solid #ccc;
        }
        #url-input-container button {
            flex-shrink: 0; margin-top: 0; background-color: #5bc0de;
        }
        #url-input-container button:hover {
            background-color: #31b0d5;
        }
        /* √Årea de Soluci√≥n de Fallo */
        #cors-error-solution {
            display: none; /* Inicialmente oculto */
            background-color: #fff3cd; 
            border: 1px solid #ffc107; 
            padding: 15px; 
            border-radius: 4px; 
            margin-bottom: 20px;
        }
        #cors-error-solution p { margin-top: 0; }
        #cors-error-solution a.button-link {
            display: inline-block;
            background-color: #ffc107;
            color: #343a40;
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 10px;
        }
        /* Opciones Avanzadas */
        .options-group { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .option-item { flex: 1 1 200px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        input[type="number"], select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        /* Lista de Archivos */
        #file-list { margin-top: 20px; list-style: none; padding: 0; }
        #file-list li { 
            padding: 10px 0; border-bottom: 1px solid #eee; display: flex; flex-direction: column; 
            align-items: flex-start; font-size: 14px;
        }
        .file-info { display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px; }
        /* Barra de Progreso */
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 4px; overflow: hidden; height: 8px; }
        .progress-bar { height: 100%; background-color: #007bff; width: 0; transition: width 0.1s; }
        button { 
            background-color: #28a745; color: white; padding: 12px 25px; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 16px; margin-top: 20px; transition: background-color 0.2s;
        }
        button:hover:not(:disabled) { background-color: #1e7e34; }
        button:disabled { background-color: #9c9c9c; cursor: not-allowed; }
        .status-ready { color: #6c757d; }
        .status-converting { color: #ffc107; font-weight: bold; }
        .status-complete { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Convertidor de Im√°genes Lote Pro</h1>
        <hr>
        <h2>üîó Cargar desde URL</h2>
        <div id="url-input-container">
            <input type="text" id="url-input" placeholder="Pega la URL de la imagen aqu√≠ (ej: https://ejemplo.com/imagen.jpg)">
            <button id="load-url-button">Cargar Imagen</button>
        </div>
        <div id="cors-error-solution">
            <p><strong>¬°Fallo de Seguridad (CORS)!</strong> El sitio web de origen est√° bloqueando la descarga autom√°tica.</p>
            <p>Para solucionarlo, por favor, haz clic en el siguiente enlace para **descargar** la imagen. Luego, arrastra el archivo descargado a la secci√≥n "Cargar desde Archivo Local".</p>
            <a id="download-assistance-link" href="#" target="_blank" class="button-link">Descargar Imagen Ahora</a>
        </div>
        <h2>üìÇ Cargar desde Archivo Local</h2>
        <div id="drop-zone">
            Arrastra y suelta im√°genes aqu√≠, o haz clic para seleccionarlas.
            <input type="file" id="file-input" multiple 
                   accept="image/*, .tif, .tiff, .ico, .gif, .bmp" hidden>
        </div>
        <p style="text-align: center; color: #6c757d; font-size: 14px; margin-bottom: 20px;">(Soporta JPG, PNG, WebP, AVIF, GIF, BMP, TIFF, etc.)</p>
        <hr>
        <h2>‚öôÔ∏è Opciones de Conversi√≥n</h2>
        <div class="options-group">
            <div class="option-item">
                <label for="output-format">Formato de Salida:</label>
                <select id="output-format">
                    <option value="image/avif">AVIF (Alto Rendimiento)</option>
                    <option value="image/webp">WebP (Com√∫nmente Usado)</option>
                    <option value="image/jpeg">JPEG (Universal)</option>
                    <option value="image/png">PNG (Transparencia)</option>
                    <option value="image/gif">GIF</option>
                    <option value="image/bmp">BMP</option>
                </select>
                <p style="font-size: 12px; color: #dc3545; margin: 5px 0 0;">*AVIF/WebP requieren soporte de navegador.</p>
            </div>
            <div class="option-item">
                <label for="quality-input">Calidad (0-100):</label>
                <input type="number" id="quality-input" value="100" min="1" max="100">
                <p style="font-size: 12px; color: #6c757d; margin: 5px 0 0;">Define la compresi√≥n de archivos con p√©rdida.</p>
            </div>
            <div class="option-item">
                <label for="resize-input">Redimensionar (Ancho en px):</label>
                <input type="number" id="resize-input" value="0" min="0">
                <p style="font-size: 12px; color: #6c757d; margin: 5px 0 0;">Ancho m√°ximo (manteniendo proporci√≥n). 0 = No redimensionar.</p>
            </div>
        </div>
        <button id="convert-button" disabled>Iniciar Conversi√≥n (0 Archivos)</button>
        <h3>üìÅ Archivos Cargados:</h3>
        <ul id="file-list">
            <li>A√∫n no se ha cargado ninguna imagen.</li>
        </ul>
    </div>
    <script>
        // --- Elementos del DOM ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const convertButton = document.getElementById('convert-button');
        const outputFormatSelect = document.getElementById('output-format');
        const qualityInput = document.getElementById('quality-input');
        const resizeInput = document.getElementById('resize-input');
        const urlInput = document.getElementById('url-input');
        const loadUrlButton = document.getElementById('load-url-button');
        const corsErrorSolution = document.getElementById('cors-error-solution');
        const downloadAssistanceLink = document.getElementById('download-assistance-link');
        let filesToConvert = [];

        // --- Funciones de Utilidad y UI ---
        function handleFiles(files) {
            const incomingFiles = Array.from(files).filter(file => {
                const type = file.type;
                const name = file.name.toLowerCase();
                return type.startsWith('image/') || name.endsWith('.tif') || name.endsWith('.tiff') || name.endsWith('.ico');
            });
            filesToConvert = [...filesToConvert, ...incomingFiles];
            updateFileList();
            updateConvertButton();
        }

        function updateFileList() {
            fileList.innerHTML = '';
            if (filesToConvert.length === 0) {
                fileList.innerHTML = '<li>A√∫n no se ha cargado ninguna imagen.</li>';
                return;
            }
            filesToConvert.forEach((file, index) => {
                const listItem = document.createElement('li');
                listItem.id = `file-item-${index}`;
                const fileName = file.name + (file.fromUrl ? ' (URL)' : '');
                listItem.innerHTML = `
                    <div class="file-info">
                        <span>${fileName}</span>
                        <span id="status-${index}" class="status-ready">Listo</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progress-${index}" class="progress-bar" style="width: 0%;"></div>
                    </div>
                `;
                fileList.appendChild(listItem);
            });
        }

        function updateConvertButton() {
            convertButton.disabled = filesToConvert.length === 0;
            convertButton.textContent = filesToConvert.length > 0
                ? `Iniciar Conversi√≥n (${filesToConvert.length} Archivos)`
                : 'Iniciar Conversi√≥n (0 Archivos)';
        }

        // --- L√ìGICA DE CARGA POR URL USANDO TU WORKER ---
        async function handleUrlInput() {
            const rawUrl = urlInput.value.trim();
            if (!rawUrl || !rawUrl.startsWith('http')) {
                alert("Por favor, introduce una URL v√°lida que empiece con http(s)://");
                return;
            }

            const WORKER_URL = 'https://trabajador1.jrgm0301.workers.dev/';
            const proxyUrl = `${WORKER_URL}?url=${encodeURIComponent(rawUrl)}`;

            corsErrorSolution.style.display = 'none';
            loadUrlButton.disabled = true;
            loadUrlButton.textContent = 'Descargando...';

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    const errorMsg = await response.text();
                    throw new Error(errorMsg || `Error ${response.status}`);
                }

                const contentType = response.headers.get("Content-Type");
                if (!contentType || !contentType.startsWith('image/')) {
                    throw new Error(`La URL no apunta a una imagen. Tipo: ${contentType}`);
                }

                const blob = await response.blob();
                const urlSegments = rawUrl.split('/');
                let fileName = urlSegments[urlSegments.length - 1].split('?')[0];
                if (!fileName || !fileName.includes('.') || fileName.length < 5) {
                    const ext = contentType.split('/')[1] || 'jpg';
                    fileName = `imagen_url.${ext}`;
                }

                const fileFromUrl = new File([blob], fileName, { type: contentType });
                fileFromUrl.fromUrl = true;
                filesToConvert.push(fileFromUrl);
                updateFileList();
                updateConvertButton();
                urlInput.value = '';
                alert(`"${fileName}" cargado exitosamente.`);
            } catch (error) {
                console.error("Error al cargar la imagen:", error);
                alert(`No se pudo cargar la imagen: ${error.message}`);
                // Opcional: mantener el fallback manual si el Worker falla
                downloadAssistanceLink.href = rawUrl;
                downloadAssistanceLink.download = "imagen-a-convertir.jpg";
                corsErrorSolution.style.display = 'block';
            } finally {
                loadUrlButton.disabled = false;
                loadUrlButton.textContent = 'Cargar Imagen';
            }
        }

        // --- L√≥gica de Conversi√≥n (sin cambios) ---
        function convertFile(file, mimeType, quality, resizeWidth, index) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const reader = new FileReader();
                const progressBar = document.getElementById(`progress-${index}`);
                const statusElement = document.getElementById(`status-${index}`);

                reader.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 33;
                        progressBar.style.width = `${percent}%`;
                        statusElement.textContent = `Leyendo... (${Math.round(percent)}%)`;
                    }
                };

                reader.onload = function(e) {
                    progressBar.style.width = '33%';
                    statusElement.textContent = 'Cargando imagen...';
                    img.onload = function() {
                        progressBar.style.width = '66%';
                        statusElement.textContent = 'Redimensionando...';
                        let width = img.width;
                        let height = img.height;
                        if (resizeWidth > 0 && resizeWidth < width) {
                            height = Math.round((height / width) * resizeWidth);
                            width = resizeWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        statusElement.textContent = 'Exportando...';
                        const formatQuality = (mimeType.includes('jpeg') || mimeType.includes('webp') || mimeType.includes('avif')) 
                                              ? (quality / 100) 
                                              : undefined;
                        canvas.toBlob(function(blob) {
                            progressBar.style.width = '100%';
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error(`Error de conversi√≥n. El formato ${mimeType} no es soportado.`));
                            }
                        }, mimeType, formatQuality);
                    };
                    img.onerror = () => reject(new Error("Error al cargar la imagen."));
                    img.src = e.target.result; 
                };
                reader.readAsDataURL(file);
            });
        }

        async function startBatchConversion() {
            if (filesToConvert.length === 0) return;
            corsErrorSolution.style.display = 'none';
            convertButton.disabled = true;
            convertButton.textContent = 'Procesando en Lote...';
            const outputMimeType = outputFormatSelect.value;
            const conversionQuality = parseInt(qualityInput.value, 10);
            const resizeMaxW = parseInt(resizeInput.value, 10);
            let outputExtension = outputMimeType.split('/')[1];
            if (outputExtension === 'jpeg') outputExtension = 'jpg';
            const convertedFiles = [];

            for (let i = 0; i < filesToConvert.length; i++) {
                const file = filesToConvert[i];
                try {
                    const blob = await convertFile(file, outputMimeType, conversionQuality, resizeMaxW, i);
                    const nameParts = file.name.split('.');
                    const extension = nameParts.length > 1 ? nameParts.pop() : '';
                    const originalName = nameParts.join('.');
                    const newName = `${originalName}_convertido.${outputExtension}`;
                    convertedFiles.push({ blob, name: newName });
                    document.getElementById(`status-${i}`).textContent = '¬°Completado!';
                    document.getElementById(`status-${i}`).className = 'status-complete';
                } catch (error) {
                    console.error(`Error al convertir ${file.name}:`, error);
                    document.getElementById(`status-${i}`).textContent = 'Error';
                    document.getElementById(`status-${i}`).className = 'status-error';
                    document.getElementById(`progress-${i}`).style.backgroundColor = '#dc3545';
                }
            }

            if (convertedFiles.length === 1) {
                const { blob, name } = convertedFiles[0];
                downloadFile(blob, name);
                convertButton.textContent = `Descarga Directa de 1 Archivo`;
            } else if (convertedFiles.length > 1) {
                await downloadAsZip(convertedFiles);
                convertButton.textContent = `Descarga ZIP Completa (${convertedFiles.length} Archivos)`;
            } else {
                convertButton.textContent = 'No se pudo convertir ning√∫n archivo.';
            }

            setTimeout(() => {
                filesToConvert = [];
                updateFileList();
                updateConvertButton();
            }, 5000);
        }

        function downloadFile(blob, fileName) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        async function downloadAsZip(files) {
            if (typeof JSZip === 'undefined') {
                alert("Error: La librer√≠a JSZip no est√° cargada.");
                return;
            }
            const zip = new JSZip();
            files.forEach(file => {
                zip.file(file.name, file.blob);
            });
            convertButton.textContent = 'Generando ZIP...';
            const content = await zip.generateAsync({ type: "blob" });
            downloadFile(content, `conversion-lote-${new Date().toISOString().slice(0, 10)}.zip`);
        }

        // --- Eventos ---
        loadUrlButton.addEventListener('click', handleUrlInput);

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('hover');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('hover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('hover');
            handleFiles(e.dataTransfer.files);
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            e.target.value = null; 
        });

        convertButton.addEventListener('click', startBatchConversion);

        updateFileList();
        updateConvertButton();
    </script>
</body>
</html>
